name: Build Zed macOS (Intel)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  CARGO_BUILD_TARGET: x86_64-apple-darwin

jobs:
  build-intel-on-arm:
    name: Build Intel Release (Cross-compile)
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rust-src

      # [修正点]：显式手动安装 Intel 架构支持库
      # 这是解决 "can't find crate for std" 的核心步骤
      - name: Add Intel Target
        run: rustup target add x86_64-apple-darwin

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      - name: Build Release Binary (Intel)
        run: cargo build --release --target x86_64-apple-darwin

      - name: Verify Architecture
        run: |
          # 检查编译出来的文件是不是 Intel 架构 (x86_64)
          file target/x86_64-apple-darwin/release/zed

      - name: Create App Bundle
        run: |
          echo "Creating Zed.app structure..."
          APP_NAME="Zed.app"
          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"

          echo "Copying Binary..."
          cp target/x86_64-apple-darwin/release/zed "$APP_NAME/Contents/MacOS/zed"

          echo "Copying Resources..."
          cp crates/zed/resources/app-icon.icns "$APP_NAME/Contents/Resources/" || echo "Icon not found"
          cp crates/zed/resources/Info.plist "$APP_NAME/Contents/" || echo "Plist not found"
          
          chmod +x "$APP_NAME/Contents/MacOS/zed"
          xattr -c "$APP_NAME" || true

      - name: Create DMG
        run: |
          npm install -g create-dmg
          create-dmg \
            --overwrite \
            --volname "Zed" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Zed.app" 200 190 \
            --hide-extension "Zed.app" \
            --app-drop-link 600 185 \
            "Zed-Intel.dmg" \
            "Zed.app"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Zed-macOS-Intel
          path: |
            Zed-Intel.dmg
            Zed.app
