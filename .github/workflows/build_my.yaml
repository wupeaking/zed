name: Build Zed macOS (Intel)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  # 强制指定构建目标为 Intel 架构 (即使 Runner 是 ARM 的)
  CARGO_BUILD_TARGET: x86_64-apple-darwin

jobs:
  build-intel-on-arm:
    name: Build Intel Release (Cross-compile)
    # 使用最新的 macOS Runner (基于 Apple Silicon)
    # 这样避免了 macos-13 的废弃警告，且编译速度通常更快
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          # 关键：安装 Intel 架构的标准库
          targets: x86_64-apple-darwin
          components: rust-src

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      # 编译步骤
      - name: Build Release Binary (Intel)
        # --target 参数告诉 Rust：虽然我在 ARM 机器上，但请给我生成 Intel 的包
        run: cargo build --release --target x86_64-apple-darwin

      # 验证步骤 (可选，用于确认生成的文件格式正确)
      - name: Verify Architecture
        run: |
          file target/x86_64-apple-darwin/release/zed
          # 应该输出: Mach-O 64-bit executable x86_64

      # 打包步骤
      - name: Create App Bundle
        run: |
          echo "Creating Zed.app structure..."
          APP_NAME="Zed.app"
          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"

          echo "Copying Binary..."
          cp target/x86_64-apple-darwin/release/zed "$APP_NAME/Contents/MacOS/zed"

          echo "Copying Resources..."
          # 尝试复制图标和 plist，如果找不到则忽略（不中断流程）
          cp crates/zed/resources/app-icon.icns "$APP_NAME/Contents/Resources/" || echo "Icon not found"
          cp crates/zed/resources/Info.plist "$APP_NAME/Contents/" || echo "Plist not found"
          
          # 确保 Plist 里没有特定于 ARM 的设置 (通常通用，但为了保险)
          # 赋予执行权限
          chmod +x "$APP_NAME/Contents/MacOS/zed"
          
          # 清除属性
          xattr -c "$APP_NAME" || true

      - name: Create DMG
        run: |
          npm install -g create-dmg
          create-dmg \
            --overwrite \
            --volname "Zed" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Zed.app" 200 190 \
            --hide-extension "Zed.app" \
            --app-drop-link 600 185 \
            "Zed-Intel.dmg" \
            "Zed.app"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Zed-macOS-Intel
          path: |
            Zed-Intel.dmg
            Zed.app
